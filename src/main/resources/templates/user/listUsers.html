<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gestion des utilisateurs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>


<div class="container my-4">
  <div class="card">
    <div class="card-body">
      <div th:replace="fragments/header :: header"></div>
      <!-- Messages de notification -->
      <div th:if="${message}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${message}"></span>
        <button type="button" class="close" data-dismiss="alert">&times;</button>
      </div>
      <!-- Ajouter une alerte d'erreur -->
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Liste des utilisateurs</h2>
        <a th:href="@{/accounts/add}" class="btn btn-success">
          <i class="fas fa-user-plus"></i> Nouvel utilisateur
        </a>
      </div>

      <!-- Si liste vide ou null -->
      <div th:if="${users == null or #lists.isEmpty(users)}" class="text-muted">
        <h3>Aucun utilisateur trouvé</h3>
      </div>

      <!-- Si liste non vide -->
      <div th:if="${users != null and !#lists.isEmpty(users)}" class="table-responsive">
        <p>Total : <strong th:text="${nbr}"></strong> utilisateur(s)</p>
        <table class="table table-hover">
          <thead class="thead-dark">
          <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Modifier rôle</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="user : ${users}">
            <td th:text="${user.id}"></td>
            <td th:text="${user.name}"></td>
            <td th:text="${user.email}"></td>
            <td>
              <span th:if="${not #lists.isEmpty(user.roles)}" th:text="${user.roles[0].role}"></span>
              <span th:if="${#lists.isEmpty(user.roles)}">No Role</span>

            </td>
            <td>
              <form method="post" th:action="@{/accounts/updateRole}">
                <div class="input-group">
                  <select name="newrole" class="form-control">
                    <option th:each="role : ${allRoles}"
                            th:value="${role.role}"
                            th:selected="${not #lists.isEmpty(user.roles) and role.role == user.roles[0].role}"
                            th:text="${role.role}">
                    </option>
                  </select>
                  <input type="hidden" name="id" th:value="${user.id}" />
                  <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-sync"></i>
                  </button>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              </form>
            </td>
            <td>
              <span th:if="${user.active == 1}" class="badge bg-success">Actif</span>
              <span th:if="${user.active == 0}" class="badge bg-danger">Inactif</span>
            </td>
            <td>
              <div class="btn-group">
                <a th:href="@{/accounts/enable/{id}/{email}(id=${user.id},email=${user.email})}"
                   class="btn btn-sm btn-outline-success"
                   th:disabled="${user.active == 1}" title="Activer">
                  <i class="fas fa-check"></i>
                </a>
                <a th:href="@{/accounts/disable/{id}/{email}(id=${user.id},email=${user.email})}"
                   class="btn btn-sm btn-outline-warning"
                   th:disabled="${user.active == 0}" title="Désactiver">
                  <i class="fas fa-times"></i>
                </a>
                <a th:href="@{/accounts/edit/{id}(id=${user.id})}" class="btn btn-sm btn-outline-info" title="Modifier">
                  <i class="fas fa-edit"></i>
                </a>
                <a th:href="@{/accounts/delete/{id}(id=${user.id})}" class="btn btn-sm btn-outline-danger" title="Supprimer"
                   onclick="return confirm('Confirmer la suppression ?');">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>


      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>